<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Libritos Jur√≠dicos</title>
  <meta name="description" content="Buscador simple de libros jur√≠dicos conectado a Google Sheets" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;          /* fondo oscuro elegante */
      --card:#111833;        /* tarjetas */
      --muted:#96a0be;       /* texto secundario */
      --text:#e9ecf5;        /* texto principal */
      --accent:#7aa2ff;      /* acento */
      --accent-2:#b2c8ff;    /* acento suave */
      --ring:rgba(122,162,255,.35);
      --shadow: 0 10px 25px rgba(0,0,0,.25), 0 6px 12px rgba(20,40,120,.25);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: radial-gradient(1000px 500px at 10% -10%, rgba(122,162,255,.08), transparent 60%),
                  radial-gradient(800px 400px at 110% 10%, rgba(178,200,255,.06), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .container{max-width:1100px;margin:0 auto;padding:28px 16px 60px}
    .app-card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow);
      backdrop-filter: blur(6px);
    }
    header{display:flex; gap:16px; align-items:center; justify-content:space-between; padding:18px 20px 4px}
    h1{font-size: clamp(22px, 2.4vw, 28px); margin:0; letter-spacing:.2px}
    .subtitle{color:var(--muted); font-size:14px; margin-top:4px}

    .toolbar{display:grid; gap:12px; grid-template-columns:1fr; padding:16px}
    @media (min-width:720px){ .toolbar{grid-template-columns: 1fr 220px;} }

    .searchbox{position:relative}
    .searchbox input{
      width:100%; padding:14px 42px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, #0f1631, #0c122a);
      color:var(--text); font-size:16px; outline:none; box-shadow: inset 0 0 0 1px transparent;
      transition: box-shadow .2s, border-color .2s, background .2s;
    }
    .searchbox input:focus{ border-color: var(--accent); box-shadow:0 0 0 4px var(--ring); }
    .searchbox .icon{position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.7}
    .searchbox .clear{position:absolute; right:10px; top:50%; transform:translateY(-50%);
      border:none; background:transparent; color:var(--muted); cursor:pointer; font-size:18px}

    .filters{display:flex; gap:8px; align-items:center; justify-content:flex-start; flex-wrap:wrap}
    .segmented{display:inline-grid; grid-auto-flow:column; gap:6px; background:#0b1230; padding:6px; border-radius:999px; border:1px solid rgba(255,255,255,.08)}
    .segmented button{border:none; background:transparent; color:var(--muted); padding:8px 14px; border-radius:999px; cursor:pointer; font-weight:600}
    .segmented button[aria-pressed="true"]{background:linear-gradient(180deg,#1b2753,#13204a); color:var(--text); box-shadow:0 1px 0 rgba(255,255,255,.05) inset}

    .table-wrap{padding:10px 16px 20px}
    .table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:var(--radius); box-shadow:var(--shadow); background:var(--card);}
    .table th, .table td{padding:14px 16px; text-align:left}
    .table thead th{font-size:12px; letter-spacing:.4px; text-transform:uppercase; color:var(--accent-2); border-bottom:1px solid rgba(255,255,255,.08); background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02))}
    .table tbody tr{border-bottom:1px solid rgba(255,255,255,.06)}
    .table tbody tr:hover{background:linear-gradient(180deg, rgba(122,162,255,.06), rgba(122,162,255,.04))}
    .badge{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; background:rgba(122,162,255,.12); border:1px solid rgba(122,162,255,.35); color:var(--accent-2); border-radius:999px; font-size:12px}

    .btn{border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; color:#0c1330; background:linear-gradient(180deg,#a7c0ff,#7aa2ff); box-shadow: 0 6px 14px rgba(122,162,255,.35)}
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform: translateY(1px)}
    .muted{color:var(--muted)}

    mark{background:rgba(255,238,0,.35); padding:0 2px; border-radius:4px}

    .footer{padding:18px 20px 26px; color:var(--muted); font-size:13px}
    a{color:var(--accent-2)}

    /* Scroll on small screens */
    .table-container{overflow:auto; border-radius:var(--radius)}
  </style>
</head>
<body>
  <div class="container">
    <div class="app-card">
      <header>
        <div>
          <h1>üìö Libritos Jur√≠dicos</h1>
          <div class="subtitle">Buscador conectado a Google Sheets (p√∫blico con enlace)</div>
        </div>
        <span class="badge" id="status">Cargando‚Ä¶</span>
      </header>

      <div class="toolbar">
        <div class="searchbox">
          <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path opacity=".4" d="M15.5 15.5L21 21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M18 10C18 13.3137 15.3137 16 12 16C8.68629 16 6 13.3137 6 10C6 6.68629 8.68629 4 12 4C15.3137 4 18 6.68629 18 10Z" stroke="currentColor" stroke-width="1.5"/></svg>
          <input id="q" type="text" placeholder="Buscar por t√≠tulo o autor‚Ä¶" autocomplete="off" />
          <button class="clear" id="clear" aria-label="Limpiar">√ó</button>
        </div>
        <div class="filters">
          <div class="segmented" role="tablist" aria-label="Filtro de campo">
            <button id="f-todo" class="segbtn" aria-pressed="true" data-field="todo">Todo</button>
            <button id="f-libro" class="segbtn" aria-pressed="false" data-field="libro">Libro</button>
            <button id="f-autor" class="segbtn" aria-pressed="false" data-field="autor">Autor</button>
          </div>
        </div>
      </div>

      <div class="table-wrap">
        <div class="table-container">
          <table class="table" id="results">
            <thead>
              <tr>
                <th style="width:45%">Libro</th>
                <th style="width:35%">Autor</th>
                <th style="width:20%">Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <!-- filas din√°micas -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="footer">
        <div>Consejo: comparte tu Google Sheet como ‚ÄúCualquiera con el enlace: Lector‚Äù.</div>
      </div>
    </div>
  </div>

  <script>
    /**
     * =============================
     *  CONFIGURACI√ìN R√ÅPIDA
     * =============================
     * 1) Reemplaza SPREADSHEET_ID por el ID de tu Google Sheet
     *    (lo que va entre /d/ y /edit en la URL). Ej.: 1AbCDEF...xyz
     * 2) Si tu hoja se llama diferente, cambia SHEET_NAME (por defecto: "libros")
     * 3) Aseg√∫rate de que el documento est√° compartido como ‚ÄúCualquiera con el enlace: Lector‚Äù.
     */
    const SPREADSHEET_ID = "1GoqoMekRvl3WB07wt4jPbPjuPIQ61EA0Ao_pIGlbDn0"; // <= üëà EDITA ESTO
    const SHEET_NAME = "libros";                    // <= üëà Cambia si tu hoja se llama distinto

    // =============================
    // Utilidades
    // =============================
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function debounce(fn, wait=180){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
    }

    function escapeHtml(str){
      return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
    }

    function highlight(text, query){
      if(!query) return escapeHtml(text);
      const pattern = query.trim().replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      if(!pattern) return escapeHtml(text);
      const re = new RegExp(`(${pattern})`, 'ig');
      return escapeHtml(text).replace(re, '<mark>$1</mark>');
    }

    // Google Visualization API -> JSON
    async function fetchSheet(spreadsheetId, sheetName){
      const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?sheet=${encodeURIComponent(sheetName)}`;
      const res = await fetch(url, { mode: 'cors' });
      const text = await res.text();
      // Respuesta viene como: google.visualization.Query.setResponse({...});
      const match = text.match(/setResponse\((.*)\);?/s);
      if(!match) throw new Error('No se pudo interpretar la respuesta de Google. Verifica que la hoja sea p√∫blica.');
      const json = JSON.parse(match[1]);
      if(json.status !== 'ok') throw new Error('Respuesta de Google no OK');
      const cols = json.table.cols.map(c => (c.label || '').toLowerCase());
      const idxLibro = cols.indexOf('libro');
      const idxAutor = cols.indexOf('autor');
      const idxLink  = cols.indexOf('link');
      if(idxLibro === -1 || idxAutor === -1 || idxLink === -1){
        throw new Error('Encabezados requeridos no encontrados: "Libro", "Autor", "Link"');
      }
      const rows = (json.table.rows || []).map(r=>{
        const c = r.c || [];
        return {
          libro: (c[idxLibro]?.v ?? '').toString(),
          autor: (c[idxAutor]?.v ?? '').toString(),
          link:  (c[idxLink]?.v  ?? '').toString()
        }
      }).filter(x => x.libro || x.autor || x.link);
      return rows;
    }

    // Render
    function renderRows(data, query='', field='todo'){
      const tbody = $('#tbody');
      const q = query.trim().toLowerCase();
      const filtered = data.filter(({libro, autor})=>{
        if(!q) return true;
        const inLibro = libro.toLowerCase().includes(q);
        const inAutor = autor.toLowerCase().includes(q);
        if(field==='libro') return inLibro;
        if(field==='autor') return inAutor;
        return inLibro || inAutor; // todo
      });

      tbody.innerHTML = filtered.map(({libro, autor, link})=>{
        const lh = (field==='autor')?libro:highlight(libro, q);
        const ah = (field==='libro')?autor:highlight(autor, q);
        const safeLink = link || '#';
        const disabled = link? '' : 'disabled';
        return `
          <tr>
            <td>${lh || '<span class="muted">(sin t√≠tulo)</span>'}</td>
            <td>${ah || '<span class="muted">(sin autor)</span>'}</td>
            <td>
              <a class="btn" target="_blank" rel="noopener" href="${safeLink}">Abrir</a>
            </td>
          </tr>`
      }).join('');

      const status = $('#status');
      status.textContent = `${filtered.length} resultado${filtered.length===1?'':'s'}`;
    }

    // Estado
    let DATA = [];
    let currentField = 'todo';

    async function init(){
      try{
        DATA = await fetchSheet(SPREADSHEET_ID, SHEET_NAME);
        renderRows(DATA);
        $('#status').textContent = `${DATA.length} libros`;
      }catch(err){
        console.error(err);
        $('#status').textContent = 'Error';
        const tbody = $('#tbody');
        tbody.innerHTML = `<tr><td colspan="3" class="muted">${escapeHtml(err.message)}<br>Revisa que el documento est√© compartido como p√∫blico y que el ID sea correcto.</td></tr>`
      }
    }

    // Interacciones
    const onInput = debounce(()=>{
      const q = $('#q').value; renderRows(DATA, q, currentField);
    }, 120);

    $('#q').addEventListener('input', onInput);
    $('#clear').addEventListener('click', ()=>{ $('#q').value=''; renderRows(DATA, '', currentField); $('#q').focus(); });

    $$('.segbtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $$('.segbtn').forEach(b=>b.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');
        currentField = btn.dataset.field;
        renderRows(DATA, $('#q').value, currentField);
      })
    });

    // GO!
    init();
  </script>
</body>
</html>
