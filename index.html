<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Libritos Jur칤dicos</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0b1020; --card:#111833; --muted:#96a0be; --text:#e9ecf5;
  --accent:#7aa2ff; --accent-2:#b2c8ff; --radius:16px;
  --shadow:0 10px 25px rgba(0,0,0,.25),0 6px 12px rgba(20,40,120,.25);
  --ring: rgba(122,162,255,.35);
}
body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--text);}
.container{max-width:1100px;margin:0 auto;padding:28px 16px 60px;}
h1{text-align:center;margin-bottom:4px;}
.subtitle{text-align:center;color:var(--muted);margin-bottom:20px;}
.hidden{display:none;}
.search-box{display:flex;justify-content:center;margin-bottom:20px;}
.search-box input{padding:12px 20px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: linear-gradient(180deg,#0f1631,#0c122a);color:var(--text);font-size:16px;outline:none;width:300px;max-width:90%;}
.search-box input:focus{border-color:var(--accent);box-shadow:0 0 0 4px var(--ring);}
table {width:100%; border-collapse:collapse; background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;}
th,td{padding:14px 16px; text-align:left;}
th{font-size:12px; text-transform:uppercase; color:var(--accent-2); border-bottom:1px solid rgba(255,255,255,.08);}
tr:hover{background:linear-gradient(180deg, rgba(122,162,255,.06), rgba(122,162,255,.04));}
a.button{display:inline-block; padding:6px 12px; background:var(--accent); color:#0c1330; border-radius:10px; text-decoration:none; font-weight:600;}
a.button:hover{filter:brightness(1.05);}
mark{background:rgba(255,238,0,.35); padding:0 2px; border-radius:4px;}
/* login */
.login-box{max-width:400px;margin:60px auto;padding:30px;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);}
.login-box h2{text-align:center;margin-bottom:20px;}
.login-box input{width:100%;padding:12px;margin-bottom:12px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:#0f1631;color:var(--text);}
.login-box button{width:100%;padding:12px;border:none;border-radius:8px;background:var(--accent);color:#0c1330;font-weight:600;cursor:pointer;}
.login-box button:hover{filter:brightness(1.05);}
.logout-btn{margin-top:20px;text-align:center;}
.logout-btn button{padding:10px 16px;border:none;border-radius:8px;background:#ff6b6b;color:white;font-weight:600;cursor:pointer;}
.logout-btn button:hover{filter:brightness(1.1);}
</style>
</head>
<body>
<div id="login" class="login-box">
  <h2>游댐 Iniciar Sesi칩n</h2>
  <input type="text" id="user" placeholder="Usuario">
  <input type="password" id="pass" placeholder="Contrase침a">
  <button onclick="login()">Entrar</button>
</div>

<div id="app" class="container hidden">
  <h1>游닄 Libritos Jur칤dicos</h1>
  <div class="subtitle">Buscador conectado a Google Sheets</div>
  <div class="search-box">
    <input type="text" id="search" placeholder="Buscar por libro o autor..."/>
  </div>
  <table id="results">
    <thead><tr><th>Libro</th><th>Autor</th><th>Acci칩n</th></tr></thead>
    <tbody></tbody>
  </table>
  <div class="logout-btn">
    <button onclick="logout()">Cerrar Sesi칩n</button>
  </div>
</div>

<script>
const SHEET_BASE_URL = "https://script.google.com/macros/s/AKfycbw2eiiwZfIyAs1BpIKi3Pf7SwUt_YFECfKFG4HV8-ZfbqgID4JkC-6hwV94eA96ABQi/exec"; // <-- pon tu nueva URL
let allData = [];
let usuarios = [];

async function fetchUsuarios(){
  const res = await fetch(SHEET_BASE_URL+"?action=usuarios");
  return await res.json();
}
async function fetchLibros(){
  const res = await fetch(SHEET_BASE_URL+"?action=libros");
  return await res.json();
}
async function logAction(usuario, tipo){
  await fetch(SHEET_BASE_URL+`?action=log&usuario=${encodeURIComponent(usuario)}&tipo=${tipo}`);
}

function highlight(text, query){
  if(!query) return text;
  const regex = new RegExp(`(${query})`, "gi");
  return text.replace(regex, "<mark>$1</mark>");
}
function renderTable(data, query=""){
  const tbody = document.querySelector("#results tbody");
  tbody.innerHTML = "";
  data.forEach(row=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${highlight(row.libro, query)}</td>
      <td>${highlight(row.autor, query)}</td>
      <td><a class="button" href="${row.link}" target="_blank">Abrir</a></td>
    `;
    tbody.appendChild(tr);
  });
}

async function login(){
  const u = document.getElementById("user").value.trim();
  const p = document.getElementById("pass").value.trim();
  const match = usuarios.find(x => x.usuario === u && x.clave === p);
  if(match){
    localStorage.setItem("libritos_user", u);
    await logAction(u,"login");
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    allData = await fetchLibros();
    renderTable(allData);
  } else {
    alert("Usuario o contrase침a incorrectos");
  }
}

async function logout(){
  const u = localStorage.getItem("libritos_user");
  if(u){
    await logAction(u,"logout");
  }
  localStorage.removeItem("libritos_user");
  location.reload();
}

document.getElementById("search").addEventListener("input", e=>{
  const q = e.target.value.trim().toLowerCase();
  const filtered = allData.filter(r=> r.libro.toLowerCase().includes(q) || r.autor.toLowerCase().includes(q));
  renderTable(filtered, q);
});

(async ()=>{
  usuarios = await fetchUsuarios();
  const currentUser = localStorage.getItem("libritos_user");
  if(currentUser && usuarios.find(u => u.usuario === currentUser)){
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    allData = await fetchLibros();
    renderTable(allData);
  }
})();
</script>
</body>
</html>
