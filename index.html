<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Libros Jur칤dicos Maestros</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#ffffff; --card:#111833; --muted:#7aa2ff; --text:#0c1330;
  --accent:#7aa2ff; --accent-2:#b2c8ff; --radius:16px;
  --shadow:0 10px 25px rgba(0,0,0,.1),0 6px 12px rgba(20,40,120,.05);
  --ring: rgba(122,162,255,.35);
}
*{box-sizing:border-box;}
body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--text);}
.container{max-width:1100px;margin:0 auto;padding:28px 16px 60px;}
h1{text-align:center;margin-bottom:4px;}
.subtitle{text-align:center;color:var(--muted);margin-bottom:20px;}
.search-box{display:flex;justify-content:center;margin-bottom:20px;}
.search-box input{padding:12px 20px;border-radius:999px;border:1px solid rgba(0,0,0,.12);background:#fefefe;color:var(--text);font-size:16px;outline:none;width:300px;max-width:90%;}
.search-box input:focus{border-color:var(--accent);box-shadow:0 0 0 4px var(--ring);}
table {width:100%; border-collapse:collapse; background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;}
th,td{padding:14px 16px; text-align:left;}
th{font-size:12px; text-transform:uppercase; color:var(--accent-2); border-bottom:1px solid rgba(255,255,255,.08);}
tr:hover{background:linear-gradient(180deg, rgba(122,162,255,.06), rgba(122,162,255,.04));}
a.button{display:inline-block; padding:6px 12px; background:var(--accent); color:#0c1330; border-radius:10px; text-decoration:none; font-weight:600;}
a.button:hover{filter:brightness(1.05);}
mark{background:rgba(255,238,0,.35); padding:0 2px; border-radius:4px;}
#loginModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);display:flex;justify-content:center;align-items:center;z-index:999;}
#loginModal .modal-content{background:#fff;padding:30px;border-radius:12px;max-width:320px;width:90%;box-shadow:0 10px 25px rgba(0,0,0,.25);}
#loginModal h2{margin-top:0;color:var(--accent);}
#loginModal input{width:100%;padding:10px;margin-bottom:12px;border-radius:8px;border:1px solid #ccc;}
#loginModal button{width:100%;padding:10px;border:none;border-radius:8px;background:var(--accent);color:#fff;font-weight:600;cursor:pointer;}
#loginModal button:hover{filter:brightness(1.05);}
.user-bar{display:flex; justify-content:flex-end; align-items:center; margin-bottom:16px;}
.user-bar span{margin-right:12px; font-weight:600; color:#7aa2ff;}
.user-bar button{padding:6px 12px; border:none; border-radius:8px; background:#7aa2ff; color:#fff; cursor:pointer;}
.user-bar button:hover{filter:brightness(1.05);}
@media(max-width:600px){.search-box{flex-direction:column;align-items:center;} th,td{font-size:14px;}}
</style>
</head>
<body>

<div id="loginModal">
  <div class="modal-content">
    <h2>Iniciar Sesi칩n</h2>
    <input type="text" id="username" placeholder="Usuario" />
    <input type="password" id="password" placeholder="Contrase침a" />
    <button id="loginBtn">Entrar</button>
    <div id="loginError" style="color:red;margin-top:8px;display:none;"></div>
  </div>
</div>

<div class="container" style="display:none;" id="mainApp">
  <h1>游닄 Libros Jur칤dicos Maestros</h1>
  <div class="subtitle">Buscador conectado a Google Sheets</div>

  <div class="user-bar">
    <span id="currentUser"></span>
    <button id="logoutBtn">Cerrar sesi칩n</button>
  </div>

  <div class="search-box">
    <input type="text" id="search" placeholder="Buscar por libro o autor..."/>
  </div>
  <table id="results">
    <thead><tr><th>Libro</th><th>Autor</th><th>Acci칩n</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
const SHEET_JSON_URL = "https://script.google.com/macros/s/AKfycbxeli2sgs8BW2lqqOKC95SGLAZWEyVLUDW4fT00Z7qhuzx-ocmnft5YsKVPSBBXbIJB/exec";
let allData = [];
let currentUser = "";

// Traer usuarios
async function fetchUsuarios() {
  const res = await fetch(SHEET_JSON_URL+"?action=usuarios");
  if(!res.ok) throw new Error("No se pudieron obtener los usuarios");
  const data = await res.json();
  return data.map(u=>({usuario: u.usuario, clave: u.clave+"", ultimoLogin: u.ultimoLogin, ultimoLogout: u.ultimoLogout}));
}

// Traer libros
async function fetchLibros() {
  const res = await fetch(SHEET_JSON_URL+"?action=libros");
  if(!res.ok) throw new Error("No se pudieron obtener los libros");
  return await res.json();
}

// Registrar login/logout
async function logUser(usuario,tipo){
  await fetch(`${SHEET_JSON_URL}?action=log&usuario=${usuario}&tipo=${tipo}`);
}

// Mostrar usuario
function showUser(username){
  document.getElementById("currentUser").textContent = `Conectado como: ${username}`;
}

// Highlight
function highlight(text, query){
  if(!query) return text;
  const regex = new RegExp(`(${query})`,"gi");
  return text.replace(regex,"<mark>$1</mark>");
}

// Render tabla
function renderTable(data, query=""){
  const tbody = document.querySelector("#results tbody");
  tbody.innerHTML="";
  data.forEach(row=>{
    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${highlight(row.libro, query)}</td>
      <td>${highlight(row.autor, query)}</td>
      <td><a class="button" href="${row.link}" target="_blank">Abrir</a></td>
    `;
    tbody.appendChild(tr);
  });
}

// Buscar
document.getElementById("search").addEventListener("input", e=>{
  const q = e.target.value.trim().toLowerCase();
  const filtered = allData.filter(r=> r.libro.toLowerCase().includes(q) || r.autor.toLowerCase().includes(q));
  renderTable(filtered,q);
});

// Login manual
document.getElementById("loginBtn").addEventListener("click", async ()=>{
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  try {
    const usuarios = await fetchUsuarios();
    const user = usuarios.find(u=>u.usuario===username && u.clave===password);
    if(user){
      currentUser = username;
      localStorage.setItem("libritosUser", username);

      document.getElementById("loginModal").style.display="none";
      document.getElementById("mainApp").style.display="block";

      showUser(username);
      await logUser(username,"login");

      allData = await fetchLibros();
      renderTable(allData);
    } else {
      const errDiv = document.getElementById("loginError");
      errDiv.style.display="block";
      errDiv.textContent="Usuario o contrase침a incorrectos";
    }
  } catch(err){
    alert("Error al obtener usuarios: "+err.message);
  }
});

// Login autom치tico desde localStorage
window.addEventListener("load", async ()=>{
  const savedUser = localStorage.getItem("libritosUser");
  if(savedUser){
    try{
      const usuarios = await fetchUsuarios();
      const user = usuarios.find(u => u.usuario === savedUser);
      if(user){
        currentUser = savedUser;
        document.getElementById("loginModal").style.display="none";
        document.getElementById("mainApp").style.display="block";

        showUser(savedUser);
        await logUser(savedUser,"login");

        allData = await fetchLibros();
        renderTable(allData);
      }
    }catch(err){
      console.error(err);
    }
  }
});

// Logout manual
document.getElementById("logoutBtn").addEventListener("click", async ()=>{
  if(currentUser){
    await logUser(currentUser,"logout");
    currentUser = "";
    localStorage.removeItem("libritosUser");
    document.getElementById("mainApp").style.display="none";
    document.getElementById("loginModal").style.display="flex";
    document.getElementById("username").value = "";
    document.getElementById("password").value = "";
  }
});

// Logout al cerrar o recargar
window.addEventListener("beforeunload", async ()=>{
  if(currentUser) await logUser(currentUser,"logout");
});
