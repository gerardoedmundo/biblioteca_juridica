<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Biblioteca Jur√≠dica para Amigos</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
    header { background: #333; color: white; padding: 10px; text-align: center; }
    h1 { font-size: 20px; margin: 5px 0; }
    .container { padding: 20px; }
    input, button { padding: 8px; margin: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    .btn { padding: 8px 12px; cursor: pointer; border: none; border-radius: 5px; }
    .btn-green { background: #28a745; color: white; }
    .btn-red { background: #dc3545; color: white; }
    .btn-blue { background: #007bff; color: white; }
    .fixed-search { position: sticky; top: 0; background: #f5f5f5; padding: 10px; z-index: 100; border-bottom: 1px solid #ccc; }
    footer { margin-top: 30px; padding: 15px; background: #eee; text-align: center; font-size: 14px; border-top: 2px solid #ccc; }
  </style>
</head>
<body>
  <header>
    <h1>üìö Biblioteca Jur√≠dica para Amigos</h1>
  </header>

  <div id="login-section" class="container">
    <h2>Ingreso al sistema</h2>
    <input type="text" id="username" placeholder="Usuario"><br>
    <input type="password" id="password" placeholder="Contrase√±a"><br>
    <button class="btn btn-blue" onclick="login()">Ingresar</button>
  </div>

  <div id="main-section" class="container" style="display:none;">
    <div class="fixed-search">
      <input type="text" id="search" placeholder="Buscar libro..." onkeyup="searchBooks()">
      <button class="btn btn-red" onclick="logout()">Cerrar sesi√≥n</button>
      <div id="admin-buttons" style="display:none; margin-top:10px;">
        <button class="btn btn-green" onclick="document.getElementById('add-user-form').style.display='block'">‚ûï Agregar Usuario</button>
      </div>
    </div>

    <table id="booksTable">
      <thead>
        <tr>
          <th>T√≠tulo</th>
          <th>Autor</th>
          <th>A√±o</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="add-user-form" style="display:none; margin-top:20px;">
      <h3>Agregar Usuario</h3>
      <input type="text" id="new-username" placeholder="Usuario">
      <input type="password" id="new-password" placeholder="Contrase√±a">
      <label><input type="checkbox" id="new-admin"> Administrador</label><br>
      <button class="btn btn-green" onclick="addUser()">Guardar Usuario</button>
    </div>
  </div>

  <footer>
    <p><b>Fundadores:</b> Lic. Miguel √Ångel S√°nchez Terr√≥n y Lic. Gerardo Edmundo Calzada Manjarrez</p>
    <p><b>Colaboradora:</b> Srita. Alondra In√©s Oca√±a Jim√©nez</p>
  </footer>

  <script>
    const BOOKS_SHEET_URL = "https://script.google.com/macros/s/AKfycb.../exec?action=getBooks";
    const USERS_SHEET_URL = "https://script.google.com/macros/s/AKfycb.../exec?action=getUsers";
    const ADD_USER_URL   = "https://script.google.com/macros/s/AKfycb.../exec?action=addUser";

    let users = [];
    let currentUser = null;

    // Cargar usuarios desde Google Sheets
    function loadUsersFromSheet() {
      return fetch(USERS_SHEET_URL)
        .then(res => res.json())
        .then(data => {
          users = [
            { user: "admin", pass: "1234", admin: true },
            ...data.map(row => ({
              user: row.user || row.Usuario || row.USUARIO,
              pass: row.pass || row.password || row.Contrase√±a || row.PASSWORD,
              admin: row.admin === true || row.admin === "TRUE" || row.Admin === "S√≠"
            }))
          ];
          console.log("Usuarios cargados:", users);
        })
        .catch(err => console.error("Error cargando usuarios:", err));
    }

    // Cargar libros desde Google Sheets
    function loadBooks() {
      fetch(BOOKS_SHEET_URL)
        .then(res => res.json())
        .then(data => {
          let tbody = document.querySelector("#booksTable tbody");
          tbody.innerHTML = "";
          data.forEach(book => {
            let row = `<tr>
              <td>${book.Titulo}</td>
              <td>${book.Autor}</td>
              <td>${book.A√±o}</td>
            </tr>`;
            tbody.innerHTML += row;
          });
        })
        .catch(err => console.error("Error cargando libros:", err));
    }

    // Buscar libros
    function searchBooks() {
      let filter = document.getElementById("search").value.toLowerCase();
      let rows = document.querySelectorAll("#booksTable tbody tr");
      rows.forEach(row => {
        let text = row.innerText.toLowerCase();
        row.style.display = text.includes(filter) ? "" : "none";
      });
    }

    // Iniciar sesi√≥n
    function login() {
      let user = document.getElementById("username").value.trim();
      let pass = document.getElementById("password").value.trim();

      let foundUser = users.find(u => u.user === user && u.pass === pass);
      if (!foundUser) {
        alert("Usuario o contrase√±a incorrectos");
        return;
      }

      currentUser = foundUser;
      document.getElementById("login-section").style.display = "none";
      document.getElementById("main-section").style.display = "block";
      if (currentUser.admin) {
        document.getElementById("admin-buttons").style.display = "block";
      } else {
        document.getElementById("admin-buttons").style.display = "none";
      }
      loadBooks();
    }

    // Cerrar sesi√≥n
    function logout() {
      currentUser = null;
      document.getElementById("login-section").style.display = "block";
      document.getElementById("main-section").style.display = "none";
      document.getElementById("username").value = "";
      document.getElementById("password").value = "";
    }

    // Agregar usuario a Google Sheets
    function addUser() {
      let user = document.getElementById("new-username").value.trim();
      let pass = document.getElementById("new-password").value.trim();
      let admin = document.getElementById("new-admin").checked;

      if (!user || !pass) {
        alert("Por favor completa todos los campos");
        return;
      }

      fetch(ADD_USER_URL, {
        method: "POST",
        body: JSON.stringify({ user, pass, admin }),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.text())
      .then(msg => {
        alert("Usuario agregado correctamente");
        document.getElementById("new-username").value = "";
        document.getElementById("new-password").value = "";
        document.getElementById("new-admin").checked = false;
        document.getElementById("add-user-form").style.display = "none";
        loadUsersFromSheet();
      })
      .catch(err => console.error("Error al agregar usuario:", err));
    }

    // Inicializar
    loadUsersFromSheet();
  </script>
</body>
</html>
