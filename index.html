<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Biblioteca Jurídica para Amigos</title>
<style>
    body { font-family: Arial, sans-serif; margin:0; background-color:#f5f5f5; }
    header { background-color:#2c3e50; color:white; padding:10px; text-align:center; font-size:20px; position:sticky; top:0; z-index:1000; }
    .container { max-width:1000px; margin:auto; padding:15px; background:white; border:1px solid #ccc; border-radius:8px; margin-top:20px; }
    .search-bar { display:flex; flex-direction:column; gap:10px; margin-bottom:15px; position:sticky; top:60px; background:white; padding:10px 0; z-index:900; }
    .search-bar input { padding:10px; border:1px solid #aaa; border-radius:5px; font-size:16px; }
    table { width:100%; border-collapse:collapse; margin-bottom:15px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; font-size:14px; }
    th { background-color:#2980b9; color:white; }
    tr:nth-child(even){background-color:#f9f9f9;}
    .btn { padding:10px 15px; border:none; border-radius:5px; font-size:14px; cursor:pointer; margin:2px; }
    .btn-green { background-color:#27ae60; color:white; }
    .btn-red { background-color:#c0392b; color:white; }
    .credits { margin-top:15px; font-size:12px; color:#555; text-align:center; }
    .panel { background-color:#f0f4f7; padding:15px; margin-bottom:15px; border-radius:5px; display:none; }
    input[type="text"], input[type="password"] { width:100%; padding:8px; margin:5px 0; border-radius:5px; border:1px solid #aaa; }
    @media(max-width:600px){ th,td{font-size:12px;} header{font-size:16px;} .btn{font-size:12px; padding:8px;} }
</style>
</head>
<body>

<header>Biblioteca Jurídica para Amigos</header>

<div class="container">
    <div id="login-section">
        <h2>Ingreso al sistema</h2>
        <input type="text" id="username" placeholder="Usuario">
        <input type="password" id="password" placeholder="Contraseña">
        <button class="btn btn-green" onclick="login()">Ingresar</button>
    </div>

    <div id="main-section" style="display:none;">
        <div class="search-bar">
            <input type="text" id="search" placeholder="Buscar por libro o autor..." onkeyup="filterBooks()">
            <div id="admin-buttons" style="display:none;">
                <button class="btn btn-green" onclick="togglePanel('manageUsersPanel')">Administrar Usuarios</button>
            </div>
            <button class="btn btn-red" onclick="logout()">Cerrar Sesión</button>
        </div>

        <!-- Panel de administración de usuarios -->
        <div id="manageUsersPanel" class="panel">
            <h3>Administrar Usuarios</h3>
            <input type="text" id="newUser" placeholder="Nombre de usuario">
            <input type="password" id="newUserPass" placeholder="Contraseña">
            <label><input type="checkbox" id="newUserAdmin"> Admin</label>
            <button class="btn btn-green" onclick="addUser()">Agregar Usuario</button>
            <div id="userList"></div>
        </div>

        <table id="books-table">
            <thead>
                <tr><th>Libro</th><th>Autor</th><th>Enlace</th></tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="credits">
            <p><strong>Fundadores:</strong> Lic. Miguel Ángel Sánchez Terrón y Lic. Gerardo Edmundo Calzada Manjarrez</p>
            <p><strong>Colaboradora:</strong> Srita. Alondra Inés Ocaña Jiménez</p>
            <p>Diseño web: Jerry</p>
            <p id="last-update">Última actualización: Cargando...</p>
        </div>
    </div>
</div>

<script>
const SHEET_USERS_URL = "https://script.google.com/macros/s/AKfycbxLwVO5l0i0qtv7pS3SxvydwMSs5vZpH6oNN5_dJ0I4m3o9SZ4CzefEKzzepj6aBc6bXw/exec"; // Cambia aquí por tu Web App

let booksData = [];
let users = [];
let currentUser = null;

// -------- Cargar usuarios desde Google Sheets --------
async function loadUsersFromSheet(){
    try{
        const res = await fetch(SHEET_USERS_URL + "?action=get");
        users = await res.json();
    }catch(err){
        console.error("Error al cargar usuarios:", err);
        users = [];
    }
}

// -------- Login --------
async function login(){
    await loadUsersFromSheet();
    const user = document.getElementById("username").value.trim();
    const pass = document.getElementById("password").value.trim();

    currentUser = users.find(u => u.user === user && u.pass === pass);
    if(!currentUser){ alert("Usuario o contraseña incorrectos"); return; }

    if(currentUser.admin){ document.getElementById("admin-buttons").style.display = "block"; }
    document.getElementById("login-section").style.display="none";
    document.getElementById("main-section").style.display="block";
    loadBooks();
    displayUsers();
}

// -------- Logout --------
function logout(){
    document.getElementById("main-section").style.display="none";
    document.getElementById("login-section").style.display="block";
    document.getElementById("username").value="";
    document.getElementById("password").value="";
}

// -------- Toggle panel admin --------
function togglePanel(panelId){
    const panel = document.getElementById(panelId);
    panel.style.display = (panel.style.display==='none')?'block':'none';
}

// -------- Agregar usuario --------
async function addUser(){
    const u = document.getElementById("newUser").value.trim();
    const p = document.getElementById("newUserPass").value.trim();
    const isAdmin = document.getElementById("newUserAdmin").checked;

    if(!u || !p){ alert("Completa todos los campos"); return; }
    if(users.find(x=>x.user===u)){ alert("Usuario ya existe"); return; }

    // Guardar en Google Sheets
    const formData = new FormData();
    formData.append("user", u);
    formData.append("pass", p);
    formData.append("admin", isAdmin);

    try{
        await fetch(SHEET_USERS_URL, {method:"POST", body:formData});
        users.push({user:u, pass:p, admin:isAdmin});
        displayUsers();
        document.getElementById("newUser").value="";
        document.getElementById("newUserPass").value="";
        document.getElementById("newUserAdmin").checked=false;
    }catch(err){
        alert("Error al guardar usuario");
        console.error(err);
    }
}

// -------- Mostrar usuarios --------
function displayUsers(){
    const list = document.getElementById("userList");
    list.innerHTML="";
    users.forEach(u=>{
        let li = document.createElement("div");
        li.innerHTML = `${u.user} ${u.admin?"(Admin)":""}`;
        list.appendChild(li);
    });
}

// -------- Libros (igual que antes) --------
async function loadBooks(){
    const url = "https://docs.google.com/spreadsheets/d/1GoqoMekRvl3WB07wt4jPbPjuPIQ61EA0Ao_pIGlbDn0/gviz/tq?tqx=out:json&sheet=libros";
    try{
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substr(47).slice(0,-2));
        booksData = json.table.rows.map(r=>({
            libro: r.c[0]?r.c[0].v:"",
            autor: r.c[1]?r.c[1].v:"",
            link: r.c[2]?r.c[2].v:""
        }));
        displayBooks(booksData);
        document.getElementById("last-update").innerText="Última actualización: "+new Date().toLocaleString();
    }catch(err){
        console.error(err);
        alert("Error al cargar libros");
    }
}

function displayBooks(data){
    const tbody = document.querySelector("#books-table tbody");
    tbody.innerHTML="";
    data.forEach(book=>{
        let row = `<tr>
            <td>${book.libro}</td>
            <td>${book.autor}</td>
            <td><a href="${book.link}" target="_blank">Ver</a></td>
        </tr>`;
        tbody.innerHTML += row;
    });
}

function filterBooks(){
    const text = document.getElementById("search").value.toLowerCase();
    const filtered = booksData.filter(b => b.libro.toLowerCase().includes(text) || b.autor.toLowerCase().includes(text));
    displayBooks(filtered);
}
</script>

</body>
</html>
