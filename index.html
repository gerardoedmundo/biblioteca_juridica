<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Libritos JurÃ­dicos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9fafb;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #1e40af;
    }
    .search-box {
      text-align: center;
      margin-bottom: 20px;
    }
    input {
      padding: 10px;
      width: 80%;
      max-width: 500px;
      border: 1px solid #ccc;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    tr:hover {
      background: #f1f5f9;
    }
    a.button {
      display: inline-block;
      padding: 6px 12px;
      background: #2563eb;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      transition: background 0.3s;
    }
    a.button:hover {
      background: #1e40af;
    }
    mark {
      background: #fde047;
      padding: 0 2px;
    }
    @media(max-width:600px){
      th, td { font-size: 14px; }
      input { width: 95%; }
    }
  </style>
</head>
<body>
  <h1>ðŸ“š Libritos JurÃ­dicos</h1>
  <div class="search-box">
    <input type="text" id="search" placeholder="Buscar por libro o autor..." />
  </div>
  <table id="results">
    <thead>
      <tr><th>Libro</th><th>Autor</th><th>Link</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const SPREADSHEET_ID = "1GoqoMekRvl3WB07wt4jPbPjuPIQ61EA0Ao_pIGlbDn0";
    const SHEET_NAME = "libros";
    let allData = [];

    async function fetchSheet(spreadsheetId, sheetName){
      const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
      const res = await fetch(url);
      const text = await res.text();

      // Separar filas
      const lines = text.split(/\r?\n/).filter(l => l.trim());

      // Detectar delimitador
      const delimiter = lines[0].includes(";") ? ";" : ",";

      // Encabezados
      const headers = lines.shift().split(delimiter).map(h => h.trim().toLowerCase());

      // Ãndices
      const idxLibro = headers.indexOf("libro");
      const idxAutor = headers.indexOf("autor");
      const idxLink  = headers.indexOf("link");

      if(idxLibro === -1 || idxAutor === -1 || idxLink === -1){
        throw new Error('Encabezados requeridos no encontrados: "Libro", "Autor", "Link"');
      }

      // Convertir a objetos
      const rows = lines.map(line => {
        const cols = line.split(delimiter);
        return {
          libro: cols[idxLibro]?.trim() || "",
          autor: cols[idxAutor]?.trim() || "",
          link:  cols[idxLink]?.trim()  || ""
        };
      }).filter(x => x.libro || x.autor || x.link);

      return rows;
    }

    function highlight(text, query){
      if(!query) return text;
      const regex = new RegExp(`(${query})`, "gi");
      return text.replace(regex, "<mark>$1</mark>");
    }

    function renderTable(data, query=""){
      const tbody = document.querySelector("#results tbody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${highlight(row.libro, query)}</td>
          <td>${highlight(row.autor, query)}</td>
          <td><a class="button" href="${row.link}" target="_blank">Abrir</a></td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.getElementById("search").addEventListener("input", e => {
      const q = e.target.value.trim().toLowerCase();
      const filtered = allData.filter(r => 
        r.libro.toLowerCase().includes(q) || r.autor.toLowerCase().includes(q)
      );
      renderTable(filtered, q);
    });

    (async ()=>{
      try {
        allData = await fetchSheet(SPREADSHEET_ID, SHEET_NAME);
        renderTable(allData);
      } catch(err){
        console.error("Error cargando datos:", err);
        alert("No se pudieron cargar los libros. Revisa que la hoja estÃ© publicada en la web.");
      }
    })();
  </script>
</body>
</html>
